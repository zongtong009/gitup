define("wiki-lemma:widget/feature/Audio/Audio.es",function(t,e,i){"use strict";function a(t){return t&&t.__esModule?t:{"default":t}}function l(t){this.lemmaId=t.lemmaId||"",this.lemmaTitle=t.lemmaTitle||"",this.catalog=t.catalog||[],this.$panel=d["default"]("#J-audio-container"),this.$prev=this.$panel.find("#J-audio-prev"),this.$toggleBtn=this.$panel.find("#J-audio-stop"),this.$audio=this.$panel.find(".J-audio-core"),this.$next=this.$panel.find("#J-audio-next");var e=localStorage.getItem("J-sound-tone");this.soundId=e?Number(e):4100,this.isPlaying=!1,this.pidList=[],this.curCatalogPid="",this.voiceData=u["default"]({lemmaTitle:t.lemmaTitle||"",pinyin:t.pinyin,catalog:t.catalog||[],extData:t.modulesData||{}}),this.currnetIndex=0,this.currentVoiceIdx=0,this.delayFlag,this.partTitleFlag,this.headerFlag,this.titleFlag,this.showSoundSelect=!1,this.initAudioSelect(),this.bindEvent()}function n(t){return P||(P=new l(t)),P}var o=t("wiki-common:widget/lib/jquery/jquery"),d=a(o),s=t("wiki-lemma:widget/feature/Audio/audioHelper.es"),u=a(s),c=t("wiki-common:widget/component/evtMsgManager/evtMsgManager.es"),r=a(c),h=t("wiki-lemma:widget/lemma_content/configModule/secondsKnowLarge/windowScroll"),f=a(h),g=t("wiki-lemma:widget/feature/Audio/ttshelper.es"),m=t("wiki-lemma:widget/feature/Audio/isCollide"),p=a(m),y=t("wiki-lemma:widget/tools/clickstream/clickstream"),v=a(y),I=r["default"].Events,P=void 0;l.prototype={initAudioSelect:function(){var t=this,e=g.soundList.reduce(function(e,i){var a=t.soundId===i.id?"checked":"";return e+='<li class="">'+i.title+'\n                <input id="sound-list-'+i.id+'" type="checkbox" value="'+i.id+'" '+a+'/>\n                <label for="sound-list-'+i.id+'"></label></li>'},"");this.$panel.find(".J-audio-select ul").append(e)},setIsplayingStatus:function(t){this.isPlaying=t,t&&r["default"].trigger(r["default"].Events.LEMMA_AUDIO_PLAY),this.allPlayPauseStyle()},addPidList:function(t){this.pidList.push(t),this.curCatalogPid=this.voiceData[this.getVoiceIndex(t)].catalogPid,this.pidListChange(t)},getCurrentPid:function(){return this.pidList[this.pidList.length-1]},_playNext:function(){var t=this.getVoiceIndex(this.getCurrentPid()),e=t+1>this.voiceData.length-1?0:t+1,i=this.voiceData[e].pid;this.addPidList(i),this.currnetIndex=e,this.currentVoiceIdx=0,this._playCurrent(),this.calcIndex(),this._cacheNext()},_playPrev:function(){var t=this.getVoiceIndex(this.getCurrentPid()),e=0>=t-1?0:t-1,i=this.voiceData[e].pid;this.addPidList(i),this.currnetIndex=e,this.currentVoiceIdx=0,this._playCurrent(),this.calcIndex(),this._cacheNext()},_playFromStart:function(){this._click2Play(),this.addPidList(0)},_togglePlay:function(t){switch(t){case"play":0===this.currnetIndex,this.toggleCatalogStyle(this.getDomByPid(this.curCatalogPid)),this.pidList.length?d["default"]("#J-audio-current")[0].play():this._playFromStart();break;case"pause":this.toggleCatalogStyle(this.getDomByPid(this.curCatalogPid),!1),d["default"]("#J-audio-current")[0].pause()}},_palyControl:function(){this.isPlaying?(this.setIsplayingStatus(!1),this._togglePlay("pause")):(this.pidList.length||(this.$panel.show(),v["default"].logViewEl({page:"lemma",element:"audio-bar",lemmaTitle:this.lemmaTitle,lemmaId:this.lemmaId}),this.textScroll(this.lemmaTitle)),this.setIsplayingStatus(!0),this._togglePlay("play"))},_click2Play:function(){this._playCurrent(),this.calcIndex(),this._cacheNext()},_autoPlay:function(){this.toggleAudioId(),this._playCurrent(),this.calcIndex(),this._cacheNext()},calcIndex:function(){var t=this.voiceData[this.currnetIndex].voice;this.currentVoiceIdx<t.length-1?this.currentVoiceIdx++:(this.currnetIndex++,this.currentVoiceIdx=0)},_playCurrent:function(){var t=this,e=this.voiceData[this.currnetIndex];g.getTTSUrl(e.voice[this.currentVoiceIdx],this.soundId).then(function(e){d["default"]("#J-audio-current").attr("src",e,0===t.currnetIndex),d["default"]("#J-audio-current")[0].play(),t.setIsplayingStatus(!0)})},_cacheNext:function(){var t=this,e=this.voiceData[this.currnetIndex];e&&g.getTTSUrl(e.voice[this.currentVoiceIdx],this.soundId).then(function(e){d["default"]("#J-audio-cache").attr("src",e,0===t.currnetIndex),d["default"]("#J-audio-cache")[0].load()})},stopPlay:function(){this.isPlaying=!1,this._togglePlay("pause"),this.allPlayPauseStyle();var t=this.getCurrentPid();this.getDomByPid(t)&&this.togglePlayTextColor(this.getDomByPid(t),!1),this.curCatalogPid="",this.pidList=[],this.currnetIndex=0,this.currentVoiceIdx=0,this.delayFlag=void 0,this.partTitleFlag=void 0,this.headerFlag=void 0,this.titleFlag=void 0,r["default"].trigger(r["default"].Events.LEMMA_AUDIO_PAUSE)},toggleAudioId:function(){d["default"]("#J-audio-current").attr("id","J-audio-old"),d["default"]("#J-audio-cache").attr("id","J-audio-current"),d["default"]("#J-audio-old").attr("id","J-audio-cache")},getVoiceIndex:function(t){var e=-1;return this.voiceData.forEach(function(i,a){i.pid===t&&(e=a)}),e},getDomByPid:function(t){return d["default"]('[data-pid="'+t+'"]')},replayCurPid:function(t){this.soundId=t,this.currnetIndex=this.getVoiceIndex(this.getCurrentPid()),this.currentVoiceIdx=0,this._playCurrent(),this.calcIndex(),this._cacheNext()},audioIconAnimation:function(t,e){var i=this,a=setInterval(function(){t.removeClass("wiki-lemma-icons_audio").addClass("wiki-lemma-icons_audio1"),setTimeout(function(){i[e]&&i[e]===a&&t.removeClass("wiki-lemma-icons_audio1").addClass("wiki-lemma-icons_audio2")},200),setTimeout(function(){i[e]&&i[e]===a&&t.removeClass("wiki-lemma-icons_audio2").addClass("wiki-lemma-icons_audio3")},400),setTimeout(function(){i[e]&&i[e]===a&&t.removeClass("wiki-lemma-icons_audio3").addClass("wiki-lemma-icons_audio1")},600)},600);this[e]=a},clearIconAnimation:function(t,e){this[e]&&(clearInterval(this[e]),this[e]=null,t.removeClass(function(t,e){return(e.match(/wiki-lemma-icons_audio\d/g)||[]).join(" ")}).addClass("wiki-lemma-icons_audio"))},togglePlayTextColor:function(t){var e=arguments.length<=1||void 0===arguments[1]?!0:arguments[1];t&&(e?t.addClass("currnet-audio-para"):t.removeClass("currnet-audio-para"))},toggleCatalogStyle:function(t){var e=arguments.length<=1||void 0===arguments[1]?!0:arguments[1];if(t&&t.length){var i=t.find(".J-part-audio-play").find("em"),a=t.find(".J-part-audio-play").find(".J-part-audio-text");e?(this.clearIconAnimation(i,"partTitleFlag"),this.audioIconAnimation(i,"partTitleFlag"),t.addClass("cur-play-catalog"),a.text("暂停")):(t.removeClass("cur-play-catalog"),a.text("语音"),this.clearIconAnimation(i,"partTitleFlag"))}},toggleBarBtnStyle:function(){this.isPlaying?d["default"]("#J-audio-stop").removeClass("wiki-lemma-icons_audio-play").addClass("wiki-lemma-icons_audio-pause"):d["default"]("#J-audio-stop").removeClass("wiki-lemma-icons_audio-pause").addClass("wiki-lemma-icons_audio-play")},toggleHeaderStyle:function(){var t=d["default"](".J-header-audio-play").find("em"),e=d["default"](".J-header-audio-play").find(".J-audio-text");this.isPlaying?(this.clearIconAnimation(t,"headerFlag"),this.audioIconAnimation(t,"headerFlag"),d["default"](".J-header-audio-play").css("color","#459DF5"),e.text("暂停")):(this.clearIconAnimation(t,"headerFlag"),d["default"](".J-header-audio-play").css("color",""),e.text("语音"))},toggleTitleStyle:function(){var t=d["default"](".J-title-audio-play").find("em"),e=d["default"](".J-title-audio-play").find(".J-audio-text");this.isPlaying?(this.clearIconAnimation(t,"titleFlag"),this.audioIconAnimation(t,"titleFlag"),e.text("暂停")):(this.clearIconAnimation(t,"titleFlag"),e.text("语音"))},progressStyle:function(){var t=228,e=this.voiceData.length,i=this.getVoiceIndex(this.getCurrentPid());i+=1,this.$panel.find(".J-audio-progress").css("width",i/e*t+"px")},allPlayPauseStyle:function(){this.toggleBarBtnStyle(),this.toggleHeaderStyle(),this.toggleTitleStyle()},textScroll:function(t){function e(){a.offsetWidth-l.scrollLeft<=0?l.scrollLeft-=i.offsetWidth:l.scrollLeft+=1}var i=this.$panel.find(".J-scroll-begin")[0],a=this.$panel.find(".J-scroll-end")[0],l=this.$panel.find(".J-audio-title")[0];i.innerHTML=t,a.innerHTML="",clearInterval(this.textTimer),d["default"](".J-scroll-begin").width()>d["default"](".J-audio-title").width()&&(this.textTimer=setInterval(e,50),a.innerHTML=i.innerHTML)},pidListChange:function(t){var e=this.getDomByPid(this.pidList[this.pidList.length-2]),i=this.getDomByPid(t);this.togglePlayTextColor(e,!1),this.togglePlayTextColor(i);var a=this.voiceData[this.getVoiceIndex(t)],l=this.pidList[this.pidList.length-2],n=l?this.voiceData[this.getVoiceIndex(l)].catalogPid:null;a.catalogPid&&a.catalogPid!==n?(n&&this.toggleCatalogStyle(this.getDomByPid(n),!1),this.toggleCatalogStyle(this.getDomByPid(a.catalogPid))):a.catalogPid||n&&this.toggleCatalogStyle(this.getDomByPid(n),!1),this.progressStyle()},bindEvent:function(){var t=this;d["default"]("body").on("click",".J-para-audio-play , .para-title[data-pid]",function(e){if(d["default"](e.target).hasClass("J-part-audio-play")||d["default"](e.target).hasClass("wiki-lemma-icons_audio")||d["default"](e.target).hasClass("J-part-audio-text")||d["default"](e.target).hasClass("J-para-audio-play")){var i=d["default"](this).data("pid");if(i!==t.getCurrentPid()){var a=t.getVoiceIndex(i);a!==t.getVoiceIndex(t.getCurrentPid())&&(t.setIsplayingStatus(!0),t.addPidList(i),t.currnetIndex=a,t.currentVoiceIdx=0,t._click2Play())}else t.replayCurPid(t.soundId)}}),d["default"]("body").on("mouseenter","[data-pid]",function(){var e=this;!t.pidList.length||d["default"](this).hasClass("J-para-audio-play ")||d["default"](this).hasClass("wiki-lemma-icons_audio")||d["default"](this).hasClass("level-2")||d["default"](this).attr("audio-id")||0===d["default"](this).data("pid")||"card"===d["default"](this).data("pid")||!d["default"](this).find(".J-para-audio-play ")||!function(){d["default"](e).addClass("audio-hover-bg");var i=d["default"](e).data("pid"),a='<em data-pid="'+i+'" \n                    class="para-audio-play J-para-audio-play cmn-icon wiki-lemma-icons wiki-lemma-icons_audio"></em>';clearTimeout(t.delayFlag),t.delayFlag=setTimeout(function(){var t=void 0;if(d["default"](e).hasClass("level-3"))d["default"](e).find(".title-text").append(a),d["default"](e).find(".J-para-audio-play ").fadeIn();else if(d["default"](e).hasClass("para-list")&&1===d["default"](e).children().length&&d["default"](e).find(".list-dot ").find(".para").length)d["default"](e).find(".para").append(a),d["default"](e).find(".J-para-audio-play ").fadeIn();else{for(var i=d["default"](e)[0].childNodes,l=i.length-1;l>=0&&!t;){var n=d["default"](i[l]);n.hasClass("lemma-album")||n.hasClass("lemma-album-marquee")||n.hasClass("lemma-picture")||3===i[l].nodeType&&""===i[l].textContent.replace(/\s/g,"")?l--:t=n}t?d["default"](a).insertAfter(t):d["default"](e).append(a),d["default"](e).find(".J-para-audio-play ").fadeIn()}},0),d["default"](e).on("mouseleave",function(){var e=this;setTimeout(function(){d["default"](e).removeClass("audio-hover-bg"),d["default"](e).find(".J-para-audio-play ").fadeOut().remove(),clearTimeout(t.delayFlag)},200),d["default"](this).off("mouseleave")})}()}),d["default"](".J-audio-core").on("ended",function(){if(0===t.currentVoiceIdx&&t.currnetIndex<t.voiceData.length){var e=t.voiceData[t.currnetIndex].pid;t.addPidList(e)}else if(t.currnetIndex>=t.voiceData.length)return t.stopPlay(),d["default"]("#J-audio-current").attr("src",""),d["default"]("#J-audio-cache").attr("src",""),void t.$panel.hide();t._autoPlay()}),d["default"]("#J-audio-prev").on("click",function(){t._playPrev()}),d["default"]("#J-audio-next").on("click",function(){t._playNext()}),d["default"]("#J-audio-stop").on("click",function(){t._palyControl()}),d["default"](".J-header-audio-play").on("click",function(){t._palyControl(),v["default"].logActClick({page:"lemma",element:"audio-header-play",status:t.isPlaying?"play":"pause",lemmaTitle:t.lemmaTitle,lemmaId:t.lemmaId})}),d["default"](".J-title-audio-play").on("click",function(){t._palyControl(),v["default"].logActClick({page:"lemma",element:"audio-title-play",status:t.isPlaying?"play":"pause",lemmaTitle:t.lemmaTitle,lemmaId:t.lemmaId})}),d["default"](".J-part-audio-play").on("click",function(e){t.pidList.length||(t.$panel.show(),v["default"].logViewEl({page:"lemma",element:"audio-bar",lemmaTitle:t.lemmaTitle,lemmaId:t.lemmaId}),t.textScroll(t.lemmaTitle));var i=d["default"](this).parent(".para-title").data("pid"),a=!1,l=t.getCurrentPid();l&&(a=i===t.voiceData[t.getVoiceIndex(l)].catalogPid),t.isPlaying?a&&(e.stopPropagation(),t.setIsplayingStatus(!1),t._togglePlay("pause")):(t.setIsplayingStatus(!0),a&&(e.stopPropagation(),t._togglePlay("play"))),v["default"].logActClick({page:"lemma",element:"audio-catalog-play",status:t.isPlaying?"play":"pause",lemmaTitle:t.lemmaTitle,lemmaId:t.lemmaId})}),r["default"].on(I.LEMMA_VIDEO_PLAY,function(){t.isPlaying=!1,t._togglePlay("pause"),t.allPlayPauseStyle()}),r["default"].on(I.LEMMA_VIDEO_PAUSE,function(){!t.pidList.length||0===t.currnetIndex&&0===t.currentVoiceIdx||(t.isPlaying=!0,t._togglePlay("play"),t.allPlayPauseStyle())}),this.$panel.on("mousedown",function(t){if(!d["default"](this).hasClass("J-audio-select")){var e=0,i=0,a=void 0,l=void 0,n=t||window.event;e=n.clientX-d["default"](this)[0].offsetLeft,i=n.clientY-d["default"](this)[0].offsetTop;var o=d["default"](this);document.onmousemove=function(t){f["default"].disableScroll();var n=t||window.event,s=n.clientX-e,u=n.clientY-i;0>s&&(s=0);var c=o.width();s>document.documentElement.clientWidth-c&&(s=document.documentElement.clientWidth-c);var r=o.height();u>document.documentElement.clientHeight-r&&(u=document.documentElement.clientHeight-r),0>u&&(u=0),o[0].style.left=s+"px",o[0].style.top=u+"px",p["default"](o[0],d["default"](".sl-player-el-container")[0])?(a=s,l=u):(o[0].style.left=a+"px",o[0].style.top=l+"px")},document.onmouseup=function(){f["default"].enableScroll(),document.onmousemove=null,document.onmouseup=null}}}),d["default"]("#J-audio-setting").on("click",function(e){e.stopPropagation(),t.showSoundSelect?(t.showSoundSelect=!1,d["default"](this).removeClass("active"),t.$panel.find(".J-audio-select").hide()):(t.showSoundSelect=!0,d["default"](this).addClass("active"),t.$panel.find(".J-audio-select").show())}),d["default"]("body").on("click",function(){t.showSoundSelect=!1,t.$panel.find(".J-audio-select").hide(),d["default"]("#J-audio-setting").removeClass("active")}),d["default"]("#J-audio-close").on("click",function(){t.stopPlay(),t.$panel.hide()}),this.$panel.find(".J-audio-select li").on("click",function(e){e.stopPropagation();var i=d["default"](this).find("input").val(),a=t.$panel.find(".J-audio-select li");a.each(function(t,e){d["default"](e).find("input").val()===i?d["default"](e).find("input").prop("checked",!0):d["default"](e).find("input").prop("checked",!1)}),t.soundId!==Number(i)&&(t.replayCurPid(Number(i)),localStorage.setItem("J-sound-tone",i))}),this.$panel.find(".J-audio-link").on("click",function(){var e=t.getCurrentPid(),i=t.getDomByPid(e),a=60,l=i[0].getBoundingClientRect(),n=document.body.scrollTop||document.documentElement.scrollTop;window.scrollTo(0,l.top+n-a)})},unBindEvent:function(){}},i.exports=n});